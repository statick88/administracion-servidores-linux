---
title: "ConfiguraciÃ³n Inicial del Sistema"
subtitle: "Usuarios, SSH y Permisos - Primeras 24 Horas"
author: "Diego Saavedra"
date: "2024-01-29"
date-format: medium
---

## ğŸ“š Objetivos de Aprendizaje

DespuÃ©s de completar este tema, serÃ¡s capaz de:

- Crear usuarios adicionales y configurar grupos
- Generar y configurar claves SSH para acceso seguro
- Entender y aplicar permisos Unix (chmod, chown)
- Configurar sudo para administraciÃ³n sin riesgos
- Optimizar la seguridad en los primeros pasos

## ğŸ¯ Por QuÃ© Esta LecciÃ³n Es CrÃ­tica

Tu servidor Ubuntu sale de la caja con **UN SOLO USUARIO ADMINISTRADOR**. Esto es un riesgo de seguridad. En Abacom, cada administrador necesita su propia cuenta, acceso SSH seguro, y permisos apropiados sin usar **root** directamente.

**Tiempo estimado**: 90-120 minutos de lectura + laboratorio

---

## 1. Usuarios y Grupos en Linux

### 1.1 Concepto Fundamental

Cada archivo y proceso en Linux tiene un **propietario (usuario)** y un **grupo**. Los permisos se asignan a estos tres niveles:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    USUARIO      â”‚     GRUPO       â”‚   OTROS         â”‚
â”‚  (propietario)  â”‚                 â”‚  (el resto)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   r w x         â”‚   r w x         â”‚   r w x         â”‚
â”‚ (4 2 1)         â”‚ (4 2 1)         â”‚ (4 2 1)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

r = lectura (read)    = 4
w = escritura (write) = 2
x = ejecuciÃ³n (exec)  = 1
```

**Ejemplo**: **755** significa:
- Usuario: 7 (4+2+1 = **rwx** = lectura + escritura + ejecuciÃ³n)
- Grupo: 5 (4+1 = **r-x** = lectura + ejecuciÃ³n)
- Otros: 5 (4+1 = **r-x** = lectura + ejecuciÃ³n)

### 1.2 Ver Usuarios y Grupos

```bash
# **Ver todos los usuarios del sistema**
cat /etc/passwd  # <1>

# **Ver solo usuarios humanos (UID >= 1000)**
getent passwd | awk -F: '$3 >= 1000 {print $1}'  # <2>

# **Ver grupos de un usuario**
groups diego  # <3>

# **Ver todos los grupos**
cat /etc/group  # <4>

# **Ver informaciÃ³n detallada de usuario actual**
id  # <5>

# **Ejemplo de salida**
uid=1000(diego) gid=1000(diego) groups=1000(diego),4(adm),24(cdrom),27(sudo)
```

1. **cat /etc/passwd** muestra base de datos de usuarios del sistema
2. **getent passwd** obtiene usuarios con UID >= 1000 (usuarios humanos, no del sistema)
3. **groups** lista todos los grupos a los que pertenece un usuario
4. **cat /etc/group** muestra base de datos de grupos del sistema
5. **id** muestra identidad del usuario actual (UID, GID y grupos)

### 1.3 Crear Usuarios Nuevos

**Crear usuario bÃ¡sico**:
```bash
# **Crear usuario 'carlos' con home en /home/carlos**
sudo useradd -m -s /bin/bash carlos  # <1>

# **Asignar contraseÃ±a**
sudo passwd carlos  # <2>
# Te pedirÃ¡ que ingreses y confirmes la contraseÃ±a
```

1. **useradd -m** crea home directory automÃ¡ticamente, **-s /bin/bash** asigna shell por defecto
2. **passwd** establece contraseÃ±a interactiva para el usuario creado

**Crear usuario con informaciÃ³n adicional**:
```bash
# **Crear usuario con comentario (nombre completo)**
sudo useradd -m -s /bin/bash -c "Carlos LÃ³pez - Administrador" carlos

# **Ver el comentario**
grep carlos /etc/passwd
# Salida: carlos:x:1001:1001:Carlos LÃ³pez - Administrador:/home/carlos:/bin/bash
```

**Crear usuario sin contraseÃ±a (para scripts)**:
```bash
# **Crear usuario de servicio**
sudo useradd -r -s /sbin/nologin nginx_backup

# **-r**: usuario del sistema (UID < 1000)
# **-s /sbin/nologin**: sin shell, no puede loguearse
```

**Crear usuario con home en ubicaciÃ³n personalizada**:
```bash
# **Para almacenar datos especiales**
sudo useradd -m -d /srv/apps/myapp -s /bin/bash appuser
```

### 1.4 Modificar Usuarios

**Cambiar informaciÃ³n de usuario**:
```bash
# **Cambiar el nombre completo**
sudo usermod -c "Carlos Manuel LÃ³pez" carlos

# **Cambiar el shell de login**
sudo usermod -s /bin/zsh carlos

# **Agregar usuario a grupo existente**
sudo usermod -aG adm carlos
# **-a**: append (agregar SIN remover otros grupos)
# **-G**: grupo suplementario

# **Cambiar el home del usuario**
sudo usermod -d /home/carlos_nuevo carlos

# **Loquear usuario (deshabilitar temporalmente)**
sudo usermod -L carlos

# **Desbloquear usuario**
sudo usermod -U carlos

# **Ver cambios**
grep carlos /etc/passwd
```

### 1.5 Crear y Gestionar Grupos

**Crear grupo nuevo**:
```bash
# **Crear grupo de administradores locales**
sudo groupadd administradores

# **Agregar usuarios al grupo**
sudo usermod -aG administradores diego
sudo usermod -aG administradores carlos

# **Verificar miembros del grupo**
getent group administradores
# Salida: administradores:x:1002:diego,carlos

# **Cambiar grupo primario de usuario**
sudo usermod -g administradores diego
# Cuidado: esto cambia el grupo por defecto para archivos nuevos
```

**Eliminar grupo**:
```bash
# **Eliminar grupo vacÃ­o**
sudo groupdel administradores

# **Si el grupo tiene archivos, primero cambiar propietario**
sudo chown -R :nuevogrupo /ruta/con/archivos
sudo groupdel viejogrupo
```

### 1.6 Eliminar Usuarios

**Opciones de eliminaciÃ³n**:
```bash
# **Eliminar usuario PERO conservar su home**
sudo userdel carlos

# **Eliminar usuario Y su home**
sudo userdel -r carlos
# **CUIDADO**: Esto elimina /home/carlos y todos sus archivos

# **Crear script para backupear antes de eliminar**
sudo tar czf /backup/carlos_$(date +%Y%m%d).tar.gz /home/carlos
sudo userdel -r carlos
```

---

## 2. SSH y Acceso Remoto Seguro

SSH (Secure Shell) es la forma profesional de administrar servidores Linux de forma remota.

### 2.1 Por QuÃ© SSH es Esencial

```
âŒ NUNCA usar telnet, rsh, o contraseÃ±a sobre red abierta
âœ… SIEMPRE usar SSH con claves criptogrÃ¡ficas
```

**Ventajas de SSH**:

- **EncriptaciÃ³n**: Todo el comunicado estÃ¡ encriptado en trÃ¡nsito
- **AutenticaciÃ³n por clave**: No hay contraseÃ±as transmitidas por la red
- **AutomatizaciÃ³n**: Scripts pueden ejecutarse sin interacciÃ³n manual
- **Port forwarding**: TÃºneles seguros para acceder a servicios remotos
- **SCP/SFTP**: Transferencia segura de archivos entre mÃ¡quinas

### 2.2 Generar Claves SSH

**En tu mÃ¡quina LOCAL (laptop/desktop)**:

```bash
# **Generar par de claves (pÃºblica + privada)**
ssh-keygen -t ed25519 -C "diego@abacom.com" -f ~/.ssh/diego_abacom

# **Alternativa si ed25519 no es soportado (legacy)**
ssh-keygen -t rsa -b 4096 -C "diego@abacom.com" -f ~/.ssh/diego_legacy

# **Opciones explicadas**:
# **-t ed25519**: Tipo moderno y seguro (recomendado)
# **-C "diego@abacom.com"**: Comentario/email para identificar
# **-f ~/.ssh/diego_abacom**: UbicaciÃ³n y nombre del archivo
```

**El sistema preguntarÃ¡ por passphrase** (contraseÃ±a para la clave):
```
Enter passphrase (empty for no passphrase): [DIGITA TU PASSPHRASE]
Enter same passphrase again: [CONFIRMA]
```

**Resultado - Dos archivos creados**:
```bash
# **Ver archivos creados**
ls -la ~/.ssh/

# **-rw-------  1 diego diego 464 Jan 29 10:30 .ssh/diego_abacom**
# **-rw-r--r--  1 diego diego 102 Jan 29 10:30 .ssh/diego_abacom.pub**

# **Privada**: NUNCA compartir, guardar en lugar seguro
# **PÃºblica**: Distribuir al servidor
```

**Ver contenido de claves**:
```bash
# **VER CLAVE PÃšBLICA (seguro compartir)**
cat ~/.ssh/diego_abacom.pub
# ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDk... diego@abacom.com

# **NUNCA mostrar clave privada en pÃºblico**
cat ~/.ssh/diego_abacom  # âš ï¸ NUNCA, NUNCA, NUNCA
```

### 2.3 Copiar Clave PÃºblica al Servidor

**OPCIÃ“N 1: Comando automÃ¡tico (RECOMENDADO)**

```bash
# **Copiar clave pÃºblica al servidor automÃ¡ticamente**
ssh-copy-id -i ~/.ssh/diego_abacom.pub diego@192.168.1.100

# **-i**: Especificar archivo de clave
# **diego**: Usuario en el servidor
# **192.168.1.100**: IP del servidor

# **Te pedirÃ¡ contraseÃ±a UNA VEZ**
# After that, you can connect without password
```

**OPCIÃ“N 2: Manual (si ssh-copy-id no funciona)**

```bash
# **En el servidor, crear directorio .ssh si no existe**
ssh diego@192.168.1.100 "mkdir -p ~/.ssh"

# **Copiar clave desde local al servidor**
cat ~/.ssh/diego_abacom.pub | \
  ssh diego@192.168.1.100 "cat >> ~/.ssh/authorized_keys"

# **Fijar permisos correctos en servidor (critico!)**
ssh diego@192.168.1.100 "chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"
```

### 2.4 Conectar sin ContraseÃ±a

**Desde tu mÃ¡quina local**:

```bash
# **Conectar usando clave especÃ­fica**
ssh -i ~/.ssh/diego_abacom diego@192.168.1.100

# **Verificar que funciona**
ssh -i ~/.ssh/diego_abacom diego@192.168.1.100 "whoami"
# Salida: diego
```

**Configurar alias SSH (opcional pero Ãºtil)**:

Crear/editar **~/.ssh/config**:
```
Host abacom-prod
    HostName 192.168.1.100
    User diego
    IdentityFile ~/.ssh/diego_abacom
    Port 22

Host abacom-backup
    HostName 192.168.1.101
    User diego
    IdentityFile ~/.ssh/diego_abacom
    Port 22
```

**Usar alias**:
```bash
# **Ahora conectar es fÃ¡cil**
ssh abacom-prod
ssh abacom-backup

# **Copiar archivos con SCP tambiÃ©n funciona**
scp miarchivo.txt abacom-prod:~/
```

### 2.5 Seguridad: Deshabilitar Acceso por ContraseÃ±a

**En el servidor, editar **/etc/ssh/sshd_config****:

```bash
# **Editar archivo SSH**
sudo nano /etc/ssh/sshd_config

# **Buscar y cambiar estas lÃ­neas**:
```

Cambios a hacer (buscar con Ctrl+W en nano):

```ini
# **ANTES:**
#PasswordAuthentication yes
#PermitRootLogin yes

# **DESPUÃ‰S:**
PasswordAuthentication no
PermitRootLogin no
PubkeyAuthentication yes
```

**Aplicar cambios**:
```bash
# **Verificar sintaxis antes de reiniciar**
sudo sshd -t
# Si no hay errores, no muestra nada

# **Reiniciar SSH**
sudo systemctl restart ssh

# **Verificar que SSH estÃ¡ corriendo**
sudo systemctl status ssh
```

**IMPORTANTE**: Antes de desabilitar contraseÃ±a, **asegurate de que tienes clave pÃºblica funcionando**. Si no, quedarÃ¡s bloqueado.

---

## 3. Permisos Unix (Chmod, Chown)

### 3.1 Entender Permisos

Cada archivo/carpeta tiene 10 caracteres de permisos:

```
drwxr-xr-x
â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚
â”‚â”‚â”‚â”‚â”‚â”‚â”‚â”‚â””â”€ Otros: x (ejecuciÃ³n)
â”‚â”‚â”‚â”‚â”‚â”‚â”‚â””â”€â”€ Otros: - (sin escritura)
â”‚â”‚â”‚â”‚â”‚â”‚â””â”€â”€â”€ Otros: r (lectura)
â”‚â”‚â”‚â”‚â”‚â””â”€â”€â”€â”€ Grupo: x (ejecuciÃ³n)
â”‚â”‚â”‚â”‚â””â”€â”€â”€â”€â”€ Grupo: - (sin escritura)
â”‚â”‚â”‚â””â”€â”€â”€â”€â”€â”€ Grupo: r (lectura)
â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€ Usuario: x (ejecuciÃ³n)
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€ Usuario: w (escritura)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ Usuario: r (lectura)
```

**Tipos de archivo**:

- **-** â†’ archivo regular
- **d** â†’ directorio
- **l** â†’ symlink (enlace simbÃ³lico)
- **c** â†’ dispositivo carÃ¡cter
- **b** â†’ dispositivo bloque

**Ejemplo prÃ¡ctico**:
```bash
# **Ver permisos de archivos**
ls -l ~/

# Salida:
# -rw-r--r--  1 diego diego  1024 Jan 29 archivo.txt
# drwxr-xr-x  2 diego diego  4096 Jan 29 carpeta/
# lrwxrwxrwx  1 diego diego    10 Jan 29 enlace -> archivo.txt
```

### 3.2 Cambiar Permisos con Chmod

**Sintaxis numÃ©rica** (mÃ¡s comÃºn):

```bash
# **Formato: chmod XXX archivo**
# **X = DÃ­gito 0-7 (suma de permisos)**

chmod 755 script.sh
# Usuario: 7 (4+2+1 = rwx)
# Grupo:   5 (4+1   = r-x)
# Otros:   5 (4+1   = r-x)

chmod 644 documento.txt
# Usuario: 6 (4+2   = rw-)
# Grupo:   4 (4     = r--)
# Otros:   4 (4     = r--)

chmod 700 archivo_privado
# Usuario: 7 (4+2+1 = rwx) - Solo propietario
# Grupo:   0 (      = ---)
# Otros:   0 (      = ---)
```

**Casos de uso comunes**:
```bash
# **Archivo ejecutable para todos**
chmod 755 /usr/local/bin/micomando

# **Archivo privado (solo dueÃ±o)**
chmod 600 ~/.ssh/authorized_keys

# **Directorio accesible (necesita x)**
chmod 755 ~/documentos/

# **Script privado de usuario**
chmod 700 ~/scripts/privado.sh

# **Archivo compartido en grupo**
chmod 640 /etc/app/config.conf
# Usuario: 6 (rw-)
# Grupo:   4 (r--)
# Otros:   0 (---)
```

**Sintaxis literal** (mÃ¡s legible pero menos comÃºn):

```bash
# **Agregar permiso de ejecuciÃ³n**
chmod +x script.sh

# **Remover permiso de escritura para grupo y otros**
chmod go-w documento.txt

# **Dar todos los permisos a todos**
chmod a+rwx archivo.txt

# **Quitar todo excepto lectura**
chmod a-x archivo.txt
chmod a-w archivo.txt
```

**Cambiar permisos recursivamente**:
```bash
# **Cambiar permisos de carpeta y contenido**
chmod -R 755 ~/miproyecto/

# **-R**: recursivo (incluye subcarpetas)

# **CUIDADO**: A veces quieres permisos diferentes para carpetas vs archivos
# Carpetas necesitan 'x' para entrar, archivos no

# **Mejor forma: archivos=644, carpetas=755**
find ~/miproyecto -type f -exec chmod 644 {} \;
find ~/miproyecto -type d -exec chmod 755 {} \;
```

### 3.3 Cambiar Propietario con Chown

**Sintaxis**: **chown [usuario]:[grupo] archivo**

```bash
# **Cambiar propietario a otro usuario**
sudo chown carlos archivo.txt

# **Cambiar propietario Y grupo**
sudo chown carlos:administradores archivo.txt

# **Cambiar solo grupo**
sudo chown :administradores archivo.txt

# **Cambiar recursivamente**
sudo chown -R carlos:administradores ~/proyectos/

# **Cambiar a usuario actual**
sudo chown $USER archivo.txt

# **Cambiar a usuario con su grupo primario**
sudo chown carlos: archivo.txt  # Nota el : al final
```

**Ejemplo prÃ¡ctico - Transferir propiedad de carpeta**:
```bash
# **Carlos entrega su proyecto a Diego**
sudo chown -R diego:administradores /home/carlos/proyecto_terminado

# **Verificar cambio**
ls -la /home/carlos/
# drwxr-xr-x  3 diego administradores  4096 Jan 29 proyecto_terminado/
```

---

## 4. Sudo: Privilegios de Administrador

### 4.1 Por QuÃ© NO Usar Root Directamente

```
âŒ Conectarse como root
âŒ Ejecutar TODOS los comandos como root
âŒ Compartir contraseÃ±a de root

âœ… Usuarios normales + sudo cuando sea necesario
âœ… AuditorÃ­a: Saber quiÃ©n hizo quÃ©
âœ… ContraseÃ±a individual por usuario
âœ… Control granular de quÃ© puede hacer cada usuario
```

**Riesgo del ejemplo**:
```bash
# **Usuario distrait comete error como root**
sudo rm -rf /var/log/*  # **INTENTA LIMPIAR LOGS**
# vs
sudo rm -rf /   # **ACCIDENTAL TECLEA ESTO EN VEZ**
# **Â¡TODO EL SERVIDOR ELIMINADO!**
```

### 4.2 Configurar Sudo

**Editar sudoers** (SIEMPRE usar visudo, no nano/vim directo):

```bash
# **Abrir editor de sudoers de forma segura**
sudo visudo

# **Buscar la secciÃ³n**:
```

Agregar al final del archivo:
```
# **Permitir que usuario carlos use TODOS los comandos sin contraseÃ±a**
carlos ALL=(ALL) NOPASSWD:ALL

# **Permitir que usuario diego use sudo CON contraseÃ±a**
diego ALL=(ALL) ALL

# **Permitir que grupo administradores use sudo sin contraseÃ±a**
%administradores ALL=(ALL) NOPASSWD:ALL

# **Permitir comandos especÃ­ficos sin contraseÃ±a**
diego ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart nginx

# **Permitir comando con argumentos especÃ­ficos**
carlos ALL=(ALL) NOPASSWD:/sbin/reboot, /sbin/halt

# **Negar comando especÃ­fico**
diego ALL=(ALL) ALL, !/usr/bin/rm
```

**Guardar**: Ctrl+X, luego Y en nano; o :wq en vim

**Verificar configuraciÃ³n**:
```bash
# **Ver quÃ© sudoers tienes**
sudo -l

# **Salida**:
# User diego may run the following commands on linux-server:
#     (ALL) ALL
```

### 4.3 Usar Sudo Correctamente

**Ejecutar comando individual**:
```bash
# **Reiniciar servicio**
sudo systemctl restart nginx

# **Te pide contraseÃ±a la primera vez**
# Luego recuerda por 15 minutos

# **Ver historial de sudo**
sudo cat /var/log/auth.log | grep sudo

# **Salida**:
# Jan 29 10:30:45 servidor sudo: diego : TTY=pts/0 ;
# PWD=/home/diego ; USER=root ; COMMAND=/usr/bin/systemctl
```

**Ejecutar como otro usuario**:
```bash
# **Ejecutar como usuario 'www-data' (usuario web)**
sudo -u www-data whoami
# Salida: www-data

# **Ãštil para testear permisos**
sudo -u www-data ls -la /var/www/
```

---

## 5. Laboratorio PrÃ¡ctico: Configurar Usuario Nuevo

### 5.1 Escenario

Tienes un nuevo administrador que ingresa a Abacom: **MarÃ­a GarcÃ­a**.

Necesitas:
1. Crear usuario 'maria' con home en **/home/maria**
2. Darle acceso SSH con clave
3. Hacerla miembro del grupo **administradores**
4. Configurar sudo sin contraseÃ±a
5. Deshabilitar acceso por contraseÃ±a

### 5.2 Pasos

**PASO 1: En tu mÃ¡quina local, generar clave para MarÃ­a**

```bash
ssh-keygen -t ed25519 -C "maria@abacom.com" -f ~/.ssh/maria_abacom
# Ingresa passphrase cuando pida
```

**PASO 2: En el servidor, crear usuario MarÃ­a**

```bash
# **Conectar al servidor**
ssh diego@192.168.1.100

# **Crear usuario**
sudo useradd -m -s /bin/bash -c "MarÃ­a GarcÃ­a - Administrador" maria

# **Crear grupo administradores si no existe**
sudo groupadd administradores 2>/dev/null || true

# **Agregar a grupo administradores**
sudo usermod -aG administradores maria

# **Verificar**
groups maria
# maria : maria administradores
```

**PASO 3: Copiar clave SSH de MarÃ­a**

```bash
# **Desde tu mÃ¡quina local**
ssh-copy-id -i ~/.ssh/maria_abacom.pub maria@192.168.1.100

# **Te pide contraseÃ±a de maria - usa la que estableciste**
```

**PASO 4: Permitir sudo sin contraseÃ±a para administradores**

```bash
# **En el servidor**
sudo visudo

# **Agregar esta lÃ­nea al final**:
%administradores ALL=(ALL) NOPASSWD:ALL

# **Guardar (Ctrl+X, Y en nano)**
```

**PASO 5: Deshabilitar login por contraseÃ±a (opcional pero recomendado)**

```bash
# **Bloquear contraseÃ±a de marÃ­a para SSH**
sudo passwd -l maria

# **Ahora MarÃ­a solo puede entrar por clave SSH**
```

**PASO 6: Verificar que funciona**

```bash
# **Desde tu mÃ¡quina local**
ssh -i ~/.ssh/maria_abacom.pub maria@192.168.1.100

# **Dentro del servidor como MarÃ­a**
sudo systemctl status ssh
# DeberÃ­a funcionar sin pedir contraseÃ±a

# **Salir**
exit
```

---

## ğŸ’¡ Ejemplos PrÃ¡cticos Multi-SO

::: {.panel-tabset}

### Ejemplo 1: Ver Usuarios del Sistema

#### Linux (Ubuntu)
```bash
# Ver todos los usuarios del sistema
$ cat /etc/passwd | head -5
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin

# Ver solo usuarios humanos (UID >= 1000)
$ getent passwd | awk -F: '$3 >= 1000 {print $1}'
diego
carlos
admin

# Ver informaciÃ³n del usuario actual
$ id
uid=1000(diego) gid=1000(diego) groups=1000(diego),4(adm),27(sudo)

# Ver grupos de un usuario
$ groups carlos
carlos : carlos developers
```

#### macOS (Darwin)
```bash
# En macOS, usuarios se almacenan en Directory Services
$ dscl . -list /Users | grep -v "^_"  # <1>
root
diego
carlos
admin

# Ver informaciÃ³n del usuario actual
$ id
uid=501(diego) gid=20(staff) groups=20(staff),12(everyone)

# Ver grupos de un usuario
$ groups carlos
carlos staff developers

# Nota: macOS NO usa /etc/passwd como Linux
# En su lugar, usa Directory Services (Open Directory)
```

1. **dscl** (Directory Service command line) es herramienta de macOS para gestionar usuarios

#### Windows (PowerShell)
```powershell
# Ver todos los usuarios locales
PS> Get-LocalUser

Name    Enabled Description
----    ------- -----------
Administrator True   Administrator account
diego   True   Regular user account
carlos  True   Regular user account
Guest   False  

# Ver informaciÃ³n del usuario actual
PS> $env:USERNAME
diego

# Ver grupos del usuario actual
PS> Get-LocalGroupMember -Group "Administrators"

ObjectClass Name          PrincipalSource
----------- ----          ---------------
User        LAPTOP\diego  Local
```

**ComparaciÃ³n:**
| SO | Comando | UbicaciÃ³n |
|----|---------|-----------|
| Linux | `cat /etc/passwd` | `/etc/passwd` |
| macOS | `dscl . -list /Users` | Directory Services |
| Windows | `Get-LocalUser` | SAM (Security Account Manager) |

### Ejemplo 2: Crear Usuario Nuevo

#### Linux (Ubuntu)
```bash
# Crear usuario 'carlos' con home
$ sudo useradd -m -s /bin/bash carlos

# Asignar contraseÃ±a
$ sudo passwd carlos
New password: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢
Retype new password: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢
passwd: password updated successfully

# Verificar
$ id carlos
uid=1001(carlos) gid=1001(carlos) groups=1001(carlos)

# Crear usuario con informaciÃ³n adicional
$ sudo useradd -m -s /bin/bash -c "Carlos LÃ³pez - Dev" carlos
```

#### macOS (Darwin)
```bash
# En macOS, crear usuario es mÃ¡s complejo (requiere GUI normalmente)
# Pero se puede hacer vÃ­a dscl:

$ sudo dscl . -create /Users/carlos  # <1>
$ sudo dscl . -create /Users/carlos UserShell /bin/bash
$ sudo dscl . -create /Users/carlos RealName "Carlos LÃ³pez"
$ sudo dscl . -create /Users/carlos UniqueID 501
$ sudo dscl . -create /Users/carlos PrimaryGroupID 20

# Crear home directory
$ sudo mkdir -p /Users/carlos
$ sudo chown carlos:staff /Users/carlos

# Asignar contraseÃ±a:
$ sudo dscl . -passwd /Users/carlos contraseÃ±a

# Verificar:
$ dscl . -read /Users/carlos
```

1. **dscl** es la forma de crear usuarios en macOS sin GUI

#### Windows (PowerShell)
```powershell
# Crear usuario nuevo
PS> $Password = Read-Host -AsSecureString "Enter password"
PS> New-LocalUser -Name "carlos" -Password $Password `
     -FullName "Carlos LÃ³pez" -Description "Developer"

Name    Enabled Description
----    ------- -----------
carlos  True   Developer

# Agregar usuario a un grupo
PS> Add-LocalGroupMember -Group "Developers" -Member "carlos"

# Verificar
PS> Get-LocalUser -Name carlos

Name    Enabled Description
----    ------- -----------
carlos  True   Developer
```

**ComparaciÃ³n:**
| SO | Comando | Complejidad |
|----|---------|-----------|
| Linux | `useradd -m carlos` | Simple |
| macOS | `dscl . -create /Users/carlos` | Complejo |
| Windows | `New-LocalUser -Name carlos` | Simple |

### Ejemplo 3: Caso Real Abacom - Crear Usuario de Servicio

#### Linux (Servidor Ubuntu)
```bash
# Crear usuario de servicio para aplicaciÃ³n web
$ sudo useradd -r -s /sbin/nologin -d /var/www/app webapp_abacom

# Verificar que NO puede conectarse
$ su - webapp_abacom
# Error: /sbin/nologin
# Nologin previene acceso interactivo

# Asignar permisos a carpetas de aplicaciÃ³n
$ sudo chown -R webapp_abacom:www-data /var/www/app
$ sudo chmod 755 /var/www/app
$ sudo find /var/www/app -type f -exec chmod 644 {} \;

# Verificar
$ ls -la /var/www/app | head -5
drwxr-xr-x  webapp_abacom www-data  /var/www/app
```

#### macOS (Servidor macOS - Deprecated)
```bash
# macOS ya NO soporta Server.app (fue discontinued en 2023)
# Pero si quisieras crear usuario de servicio:

$ sudo dscl . -create /Users/webapp_abacom
$ sudo dscl . -create /Users/webapp_abacom UserShell /usr/sbin/nologin
$ sudo dscl . -create /Users/webapp_abacom RealName "Abacom Web App"

# Mejor: Usar Docker o Kubernetes en lugar de macOS para servidores
```

#### Windows (Windows Server)
```powershell
# Crear cuenta de servicio (service account) para aplicaciÃ³n
PS> $ServicePassword = ConvertTo-SecureString "Complex!Pass123" -AsPlainText -Force
PS> New-LocalUser -Name "svc_abacom" -Password $ServicePassword `
     -Description "Service account for Abacom Web App" `
     -PasswordNeverExpires

# Asignar permisos NTFS
PS> $ACL = Get-Acl "C:\www\app"
PS> $AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule `
     ("svc_abacom", "Modify", "ContainerInherit,ObjectInherit", "None", "Allow")
PS> $ACL.AddAccessRule($AccessRule)
PS> Set-Acl "C:\www\app" $ACL

# Crear tarea planificada (equivalente a systemd service)
PS> $TaskAction = New-ScheduledTaskAction -Execute "C:\app\webapp.exe"
PS> $TaskTrigger = New-ScheduledTaskTrigger -AtStartup
PS> Register-ScheduledTask -TaskName "AbacomWebApp" `
     -Action $TaskAction -Trigger $TaskTrigger `
     -User "svc_abacom" -Password $ServicePassword
```

**ComparaciÃ³n arquitectura de servicios:**
| Aspecto | Linux | macOS | Windows |
|--------|-------|-------|---------|
| Usuario servicio | `useradd -r` | `dscl` (limitado) | `New-LocalUser` |
| Gestor servicios | systemd | launchd | Task Scheduler |
| Recomendado para | âœ… ProducciÃ³n | âš ï¸ Desarrollo | âœ… ProducciÃ³n |

:::

---

## 6. Ejercicios PrÃ¡cticos

### Ejercicio 1: Crear usuario de desarrollo

Crea usuario **dev_app** que:
- Tenga home en **/home/dev_app**
- Pertenezca al grupo **developers** (crear grupo primero)
- Pueda ejecutar solo **systemctl restart app** sin contraseÃ±a
- NO pueda ejecutar otros comandos con sudo

**SoluciÃ³n**:
```bash
sudo groupadd developers
sudo useradd -m -s /bin/bash -g developers dev_app
sudo usermod -aG developers dev_app
sudo visudo
# Agregar: dev_app ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart app
```

### Ejercicio 2: Asignar permisos correctos

Tienes una carpeta **/var/www/app** con estos requisitos:
- Propietario: usuario **www-data**
- Grupo: **developers**
- Archivos: legibles por grupo, no editables por otros
- Carpetas: accesibles por grupo

**SoluciÃ³n**:
```bash
sudo chown -R www-data:developers /var/www/app
sudo chmod -R 755 /var/www/app  # Carpetas
sudo find /var/www/app -type f -exec chmod 644 {} \;  # Archivos
# Resultado: Grupo puede leer/ejecutar, otros solo leer carpetas
```

### Ejercicio 3: Configurar SSH para usuario nuevo

Dado usuario **carlos** en servidor **prod.abacom.com**:
- Generar clave SSH
- Copiar al servidor
- Crear alias SSH
- Verificar acceso sin contraseÃ±a

**SoluciÃ³n**:
```bash
# Local
ssh-keygen -t ed25519 -C "carlos@abacom.com" -f ~/.ssh/carlos_prod

# Copiar clave
ssh-copy-id -i ~/.ssh/carlos_prod.pub carlos@prod.abacom.com

# Crear alias (~/.ssh/config)
echo "Host abacom-prod
    HostName prod.abacom.com
    User carlos
    IdentityFile ~/.ssh/carlos_prod" >> ~/.ssh/config

# Verificar
ssh abacom-prod whoami
# carlos
```

---

## 7. Quiz de VerificaciÃ³n

1. **Â¿CuÃ¡l es el permiso 755 en tÃ©rminos legibles?**
   - A) rwxrwxrwx
   - B) rwxr-xr-x âœ…
   - C) rw-rw-rw-
   - D) r--r--r--

2. **Â¿CuÃ¡l es el comando para ver quÃ© permisos sudo tiene un usuario?**
   - A) sudo --list âœ…
   - B) sudo -l
   - C) sudo -L
   - D) Opciones B y C son correctas âœ…

3. **Â¿Por quÃ© es importante deshabilitar acceso SSH por contraseÃ±a?**
   - A) Las claves SSH son criptogrÃ¡ficamente mÃ¡s seguras
   - B) Protege contra ataques de fuerza bruta
   - C) ContraseÃ±as viajan sin encriptaciÃ³n
   - D) Todas las anteriores âœ…

4. **Â¿QuÃ© hace **sudo usermod -aG administradores diego**?**
   - A) Cambia el grupo primario de diego a administradores
   - B) Agrega diego al grupo administradores (sin remover otros)
   - C) Solo establece diego como administrador del sistema
   - D) Respuesta B es correcta âœ…

5. **Â¿CuÃ¡l es la diferencia entre **userdel carlos** y **userdel -r carlos**?**
   - A) El primero solo elimina el usuario, el segundo tambiÃ©n elimina /home/carlos âœ…
   - B) No hay diferencia
   - C) -r elimina permisos sudo
   - D) -r requiere confirmaciÃ³n

---

## 8. Resumen y Siguiente Paso

### Lo Aprendido

âœ… Crear y gestionar usuarios (**useradd**, **usermod**, **userdel**)
âœ… Trabajar con grupos para organizar usuarios
âœ… Configurar SSH con claves criptogrÃ¡ficas
âœ… Entender permisos Unix (**chmod**, **chown**)
âœ… Usar sudo sin comprometer seguridad

### Siguiente: Unidad 2.4

El prÃ³ximo tema cubre:
- ActualizaciÃ³n segura del sistema
- Firewall bÃ¡sico (UFW)
- Hardening de primeros pasos

---

## ğŸ“š Referencias

[@ubuntu_usermanagement]
[@linuxfoundation_perms]
[@ssh_secure_practices]
[@debian_sudoers]

---

## ğŸ“ Quiz: ConfiguraciÃ³n Inicial

```{quizdown}
---
shuffleAnswers: true
---

## Â¿CuÃ¡l es el comando para crear un nuevo usuario en Ubuntu?

- [ ] addnew usuario
- [x] useradd -m -s /bin/bash usuario
- [ ] newuser usuario
- [ ] create user usuario

## Â¿QuÃ© opciÃ³n **-m** hace en el comando **useradd**?

- [ ] Hace el usuario miembro de un grupo
- [x] Crea el directorio home del usuario
- [ ] Asigna permisos de mÃ³dulo
- [ ] Modifica la contraseÃ±a

## Â¿CuÃ¡l es el archivo donde se almacenan los grupos en Ubuntu?

- [ ] /etc/groups
- [x] /etc/group
- [ ] /etc/group.conf
- [ ] /var/group

## Â¿QuÃ© comando aÃ±ade un usuario existente a un grupo?

- [ ] useradd -G grupo usuario
- [x] usermod -aG grupo usuario
- [ ] addgroup usuario grupo
- [ ] group add usuario grupo

## En permisos Unix **rwxrwxrwx**, Â¿QuÃ© representa cada bloque de 3 caracteres?

- [x] Propietario, Grupo, Otros
- [ ] Lectura, Escritura, EjecuciÃ³n (para todos)
- [ ] Usuario, Administrador, Sistema
- [ ] Archivo, Directorio, Enlace

## Â¿CuÃ¡l es el equivalente octal de permisos **rwxr-xr-x**?

- [ ] 777
- [ ] 666
- [x] 755
- [ ] 750

## Â¿QuÃ© comando cambia el propietario de un archivo?

- [ ] chowner
- [x] chown
- [ ] chmod owner
- [ ] chgrp

## Â¿CuÃ¡l es la diferencia principal entre SSH con contraseÃ±a y SSH con clave?

- [ ] No hay diferencia
- [x] Las claves criptogrÃ¡ficas son mÃ¡s seguras que contraseÃ±as
- [ ] Las contraseÃ±as son mÃ¡s seguras
- [ ] Los niveles de seguridad son iguales

## En autenticaciÃ³n SSH, Â¿CuÃ¡l es la clave que NO debe compartirse?

- [ ] Clave pÃºblica
- [x] Clave privada
- [ ] Clave de sesiÃ³n
- [ ] Clave de host

## Â¿CuÃ¡l comando genera una nueva pareja de claves SSH en ed25519?

- [ ] ssh-keygen -t rsa
- [x] ssh-keygen -t ed25519
- [ ] ssh-key -new ed25519
- [ ] generate-ssh-key ed25519

## Â¿CuÃ¡l es el archivo que contiene las claves pÃºblicas SSH autorizadas?

- [ ] ~/.ssh/authorized_keys.pub
- [x] ~/.ssh/authorized_keys
- [ ] ~/.ssh/public_keys
- [ ] /etc/ssh/authorized_keys

## Â¿QuÃ© es sudo?

- [ ] Super user directory
- [x] Super User DO - permite ejecutar comandos como administrador
- [ ] Sistema de usuario dual
- [ ] SincronizaciÃ³n de directorios

## Â¿CuÃ¡l archivo se edita para dar permisos sudo a un usuario?

- [ ] /etc/sudo.conf
- [x] /etc/sudoers (se edita con visudo)
- [ ] /etc/permissions
- [ ] /etc/sudo-permissions

## Â¿QuÃ© significa la lÃ­nea `%sudo ALL=(ALL:ALL) ALL` en sudoers?

- [ ] Miembros del grupo sudo pueden ejecutar ciertos comandos
- [x] Miembros del grupo sudo pueden ejecutar cualquier comando como cualquier usuario
- [ ] Solo el usuario sudo tiene permisos
- [ ] Todos pueden ejecutar comandos como sudo

## Â¿CuÃ¡l es una buena prÃ¡ctica de seguridad para SSH?

- [ ] Permitir acceso root directo por SSH
- [ ] Usar contraseÃ±as dÃ©biles
- [x] Deshabilitar la autenticaciÃ³n por contraseÃ±a y usar solo claves
- [ ] Cambiar puerto SSH a 22
```

---

