---
title: "ActualizaciÃ³n y Seguridad del Sistema"
subtitle: "Mantener Ubuntu Seguro y Actualizado"
author: "Diego Saavedra"
date: "2024-01-29"
date-format: medium
---

## ğŸ“š Objetivos de Aprendizaje

DespuÃ©s de completar este tema, serÃ¡s capaz de:

- Actualizar el sistema Linux de forma segura
- Entender las diferencias entre **update**, **upgrade**, y **dist-upgrade**
- Configurar actualizaciones automÃ¡ticas
- Instalar y usar firewall UFW
- Aplicar hardening bÃ¡sico de seguridad
- Monitorear cambios de seguridad

## ğŸ¯ Por QuÃ© Este Tema Es CrÃ­tico

Un servidor sin actualizar es un servidor comprometido. **0-day exploits** (vulnerabilidades nuevas) se descubren regularmente, y los parches salen diariamente. Tu servidor debe estar actualizado.

**EstadÃ­stica real**: El 80% de brechas de seguridad podrÃ­an haberse prevenido con actualizaciones oportunas.

**Tiempo estimado**: 60-90 minutos de lectura + laboratorio

---

## ğŸ’¡ Ejemplos PrÃ¡cticos Multi-SO

::: {.panel-tabset}

### Ejemplo 1: Actualizar Sistema Operativo

#### Linux (Ubuntu)
```bash
# Paso 1: Actualizar lista de paquetes
$ sudo apt update  # <1>
Get:1 http://security.ubuntu.com/ubuntu jammy-security InRelease [114 kB]
Leyendo listas de paquetes... Hecho

# Paso 2: Actualizar paquetes instalados
$ sudo apt upgrade -y  # <2>
Se instalarÃ¡n las siguientes actualizaciones:
  openssl ssh systemd vim curl wget
0 paquetes reciÃ©n instalados, 5 para actualizar
Â¿Deseas continuar? [S/n] S

# Paso 3: Limpiar paquetes no usados
$ sudo apt autoremove -y  # <3>
Los siguientes paquetes serÃ¡n ELIMINADOS:
  libpython3.8-minimal
Â¿Deseas continuar? [S/n] S

# Verificar versiÃ³n del kernel despuÃ©s
$ uname -r  # <4>
5.15.0-89-generic
```

1. **apt update** descarga la lista de paquetes disponibles de repositorios remotos (sin instalar nada)

2. **apt upgrade** instala versiones mÃ¡s recientes de paquetes ya instalados (-y responde "sÃ­" automÃ¡ticamente)

3. **apt autoremove** elimina dependencias instaladas pero ya no necesitadas (limpia espacio)

4. **uname -r** muestra la versiÃ³n actual del kernel Linux

#### macOS (Darwin)
```bash
# macOS usa dos sistemas de actualizaciÃ³n:

# Sistema A: Actualizaciones de SO (via App Store / Sistema)
$ softwareupdate -l  # <1>
The following updates are available:
  macOS Sonoma 14.2.1 Update
  Security Update 2024-001
  
# Instalar todas las actualizaciones
$ sudo softwareupdate -ia
Installing macOS Sonoma 14.2.1 Update
# Requiere reinicio

# Sistema B: Homebrew (package manager de terceros)
$ brew update  # <2>
Updated 2 taps and 215 formulae

$ brew upgrade  # <2>
Upgrading curl, openssl, wget
```

1. **softwareupdate** es el gestor de actualizaciones de SO en macOS

2. **brew** es el package manager externo mÃ¡s popular en macOS (similar a apt en Linux)

#### Windows (PowerShell)
```powershell
# Windows tiene actualizaciÃ³n automÃ¡tica (Windows Update)
# Pero tambiÃ©n puedes forzar actualizaciones vÃ­a PowerShell:

# Ver actualizaciones disponibles
PS> Get-WindowsUpdate
Title                                  KB        Size
-----                                  --        ----
Cumulative Update for Windows 11        KB5034441  800MB
Security Update for .NET Framework 4.8 KB5034440  150MB

# Instalar actualizaciones (requiere privilegios admin)
PS> Install-WindowsUpdate -AcceptAll -AutoReboot

# Verificar versiÃ³n del SO
PS> [Environment]::OSVersion.Version
10.0.22621.0  # Windows 11 Build 22621
```

**ComparaciÃ³n:**
| SO | Comando | Gestor | AutomÃ¡tico |
|----|---------|--------|-----------|
| Linux | `apt update && apt upgrade` | apt | Configurable |
| macOS | `softwareupdate -ia` | App Store + brew | SÃ­, con popup |
| Windows | `Install-WindowsUpdate` | Windows Update | SÃ­, forzado |

### Ejemplo 2: Verificar Vulnerabilidades de Seguridad

#### Linux (Ubuntu)
```bash
# Ver historial de parchesaplicados
$ sudo apt log  # <1>
# O ver el archivo de log:
$ sudo tail -f /var/log/apt/history.log

# Verificar CVEs (Common Vulnerabilities) en paquetes instalados
$ sudo apt list --upgradable
Listado de paquetes con actualizaciones disponibles:
curl/jammy 7.81.0-1ubuntu1.14 7.81.0-1ubuntu1.15
openssh-client/jammy 1:8.2p1-4ubuntu0.5 1:8.2p1-4ubuntu0.6

# Instalar ubuntu-security-status (mÃ¡s informaciÃ³n)
$ sudo apt install ubuntu-security-status
$ ubuntu-security-status --json
# Muestra vulnerabilidades conocidas

# Ver vulnerabilidades recientes
$ sudo unattended-upgrade --debug
# Muestra quÃ© estÃ¡ siendo parcheado automÃ¡ticamente
```

1. **apt log** muestra el historial de instalaciones y actualizaciones

#### macOS (Darwin)
```bash
# macOS tiene vulnerabilidades de seguridad reportadas en:
$ sudo softwareupdate -l
# Mostrada en formato: "Security Update XXXX-XXX"

# Para anÃ¡lisis mÃ¡s detallado, usar herramientas de terceros:
$ brew install clamav  # Antivirus
$ freshclam  # Actualizar base de datos de virus
$ clamscan -ri /Users  # Escanear el sistema

# Verificar historial de updatesde seguridad
$ log show --predicate 'eventMessage contains "Update"' --last 1h
```

#### Windows (PowerShell)
```powershell
# Windows tiene Windows Security (built-in)
# Verificar estado desde PowerShell:

PS> Get-MpComputerStatus | Select-Object RealTimeProtectionEnabled, OnAccessProtectionEnabled
RealTimeProtectionEnabled    OnAccessProtectionEnabled
---------------------------  -------------------------
True                         True

# Ver historial de updates
PS> Get-WinEvent -LogName System -FilterXPath "*[System[(EventID=19)]]" | Select-Object TimeCreated, Message | head -5
TimeCreated             Message
-----------             -------
2024-01-29 10:30:00     Update KB5034441 installed successfully

# Verificar si hay updates pendientes
PS> (New-Object -ComObject Microsoft.Update.Session).CreateupdateSearcher().Search("IsHidden=0 and Type='Software'").Updates.Count
# Si devuelve 0: Sistema actualizado
```

**ComparaciÃ³n:**
| SO | Herramienta | Comando | Frecuencia |
|----|-----------|---------|-----------|
| Linux | unattended-upgrades | `apt upgrade` | Configurable (diario tÃ­pico) |
| macOS | Software Update | `softwareupdate -l` | AutomÃ¡tico (con notificaciÃ³n) |
| Windows | Windows Update | AutomÃ¡tico | Forzado (Patch Tuesday) |

### Ejemplo 3: Caso Real Abacom - Configurar Firewall y Seguridad

#### Linux (UFW Firewall)
```bash
# En Abacom, usamos UFW para proteger servidores

# Paso 1: Habilitar firewall
$ sudo ufw enable  # <1>
Firewall is active and enabled on system startup

# Paso 2: Ver estado
$ sudo ufw status  # <2>
Status: active
To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
80/tcp                     ALLOW       Anywhere
443/tcp                    ALLOW       Anywhere

# Paso 3: Permitir puertos especÃ­ficos
$ sudo ufw allow 22/tcp  # <3>
$ sudo ufw allow 80/tcp  # <3>
$ sudo ufw allow 443/tcp # <3>

# Paso 4: Denegar todo lo demÃ¡s (default)
$ sudo ufw default deny incoming  # <4>
$ sudo ufw default allow outgoing # <4>

# Verificar firewall log
$ sudo tail -f /var/log/ufw.log  # <5>
```

1. **ufw enable** activa el firewall y configura inicio automÃ¡tico al bootear

2. **ufw status** muestra reglas activas (puerto, acciÃ³n, origen)

3. **ufw allow** abre un puerto especÃ­fico (SSH:22, HTTP:80, HTTPS:443 son estÃ¡ndar)

4. **ufw default deny/allow** configura polÃ­tica por defecto (rechazar entrada, permitir salida)

5. **tail -f** muestra en tiempo real los intentos bloqueados por el firewall

#### macOS (Built-in Firewall)
```bash
# macOS tiene firewall built-in (menos potente que UFW)

# Habilitar firewall
$ sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
Firewall is now enabled

# Ver estado
$ sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate
Firewall is enabled

# Permitir aplicaciÃ³n especÃ­fica
$ sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/bin/python3

# Mejor opciÃ³n: Usar herramientas de terceros como Hands Off! o Little Snitch
# O usar pfctl (Advanced BSD firewall)
$ sudo pfctl -e  # Habilitar PF firewall
```

#### Windows (Windows Defender Firewall)
```powershell
# En Windows Server, usar Windows Defender Firewall

# Ver estado del firewall
PS> Get-NetFirewallProfile

Name             Enabled
----             -------
Domain           True
Private          True
Public           True

# Crear regla de firewall (permitir SSH en puerto 22)
PS> New-NetFirewallRule -DisplayName "Allow SSH" `
     -Direction Inbound -LocalPort 22 -Protocol TCP -Action Allow

# Ver reglas activas
PS> Get-NetFirewallRule -Direction Inbound -Action Allow | Select-Object DisplayName

# MÃ¡s seguro: Denegar todo por defecto
PS> Set-NetFirewallProfile -DefaultInboundAction Block -DefaultOutboundAction Allow
```

**ComparaciÃ³n arquitectura:**
| Aspecto | Linux (UFW) | macOS | Windows |
|--------|-----------|-------|---------|
| Facilidad | âœ… Simple | âš ï¸ Complejo | âœ… GUI intuitiva |
| Control | âœ… Total | âš ï¸ Limitado | âœ… Granular |
| ProducciÃ³n | âœ… Ideal | âŒ No | âœ… Viable |
| Port blocking | âœ… SÃ­ | âš ï¸ DifÃ­cil | âœ… SÃ­ |

:::

---

## 1. GestiÃ³n de Paquetes con APT (Debian/Ubuntu)

### 1.1 Entender APT (Advanced Package Tool)

APT es el gestor de paquetes estÃ¡ndar en Debian y Ubuntu. Mantiene un Ã­ndice de repositorios remotos.

```bash
# **El ciclo de actualizaciÃ³n**
apt update    â†’ Descargar listas de paquetes nuevos
apt upgrade   â†’ Instalar versiones nuevas (sin remover paquetes)
apt autoremove â†’ Eliminar dependencias no utilizadas
```

### 1.2 Actualizar Repositorios

```bash
# **Descargar listas de paquetes desde repositorios**
sudo apt update  # <1>

# **Salida esperada**:
# Get:1 http://security.ubuntu.com/ubuntu focal-security InRelease [114 kB]
# Get:2 http://archive.ubuntu.com/ubuntu focal-updates InRelease [99.8 kB]
# Leyendo listas de paquetes... Hecho
# Se construirÃ¡n 312 nuevos paquetes

# **Â¿QuÃ© hace?**
# - Conecta a repositorios configurados en /etc/apt/sources.list
# - Descarga lista de paquetes disponibles y versiones
# - Si ves "Get", estÃ¡ descargando; "Hit" = sin cambios
```

1. **apt update** descarga lista actualizada de paquetes disponibles en repositorios (sin instalar nada)

**Verificar repositorios configurados**:
```bash
# **Ver fuentes APT**
cat /etc/apt/sources.list

# **Salida tÃ­pica**:
# deb http://archive.ubuntu.com/ubuntu/ jammy main restricted
# deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted
# deb http://security.ubuntu.com/ubuntu jammy-security main restricted universe

# **Carpeta de repositorios adicionales (PPA)**
ls -la /etc/apt/sources.list.d/
```

### 1.3 Actualizar Paquetes

**OPCIÃ“N 1: Upgrade (seguro - no elimina paquetes)**

```bash
# **Actualizar paquetes instalados a versiÃ³n mÃ¡s reciente**
sudo apt upgrade

# **Salida**:
# Leyendo listas de paquetes... Hecho
# Creando Ã¡rbol de dependencias
# Obteniendo informaciÃ³n del estado... Hecho
# Se instalarÃ¡n las siguientes actualizaciones:
#   openssl ssh systemd vim curl wget
# 0 paquetes reciÃ©n instalados, 5 para actualizar, 0 para remover
# Â¿Deseas continuar? [S/n] S

# **Ventaja**: Nunca rompe dependencias
# **Desventaja**: A veces no puede instalar actualizaciones importantes
```

**OPCIÃ“N 2: Full-Upgrade (mÃ¡s agresivo - puede remover paquetes)**

```bash
# **ActualizaciÃ³n mÃ¡s completa (puede remover dependencias antiguas)**
sudo apt full-upgrade

# **Diferencia**: Si openssl 3.0 necesita remover openssl 1.1,
# full-upgrade lo harÃ¡; upgrade NO
```

**OPCIÃ“N 3: Dist-Upgrade (Actualizar distribuciÃ³n - CUIDADO)**

```bash
# **Saltar a versiÃ³n mayor de Ubuntu (22.04 -> 24.04)**
sudo apt dist-upgrade
# âš ï¸ SOLO despuÃ©s de backup completo
# âš ï¸ SOLO en ambiente de testing primero

# **Mejor forma de actualizar distribuciÃ³n**:
sudo do-release-upgrade
# Esta herramienta es mÃ¡s segura para saltos mayores
```

### 1.4 Limpiar Paquetes No Usados

```bash
# **Eliminar paquetes de dependencias que ya no se usan**
sudo apt autoremove

# **Salida**:
# Los siguientes paquetes serÃ¡n ELIMINADOS:
#   libpython3.8-minimal
# 0 nuevos paquetes instalados, 0 actualizaciones, 1 para remover
# Â¿Deseas continuar? [S/n] S

# **Eliminar cachÃ©s de paquetes descargados**
sudo apt autoclean

# **Eliminar TODO lo que tenga cachÃ© (mÃ¡s agresivo)**
sudo apt clean
```

### 1.5 Actualizar Paquete EspecÃ­fico

```bash
# **Actualizar solo nginx a versiÃ³n mÃ¡s reciente**
sudo apt install --only-upgrade nginx

# **Instalar versiÃ³n especÃ­fica**
sudo apt install nginx=1.24.0-1~jammy

# **Ver versiones disponibles**
apt-cache policy nginx
# nginx:
#   Instalada: 1.18.0-6ubuntu14.3
#   Candidato: 1.24.0-1~jammy
#   Tabla de versiÃ³n:
#     1.24.0-1~jammy 500
#     1.18.0-6ubuntu14.3 500
```

---

## 2. Actualizaciones AutomÃ¡ticas

### 2.1 Instalar Unattended-Upgrades

En producciÃ³n, quieres actualizaciones automÃ¡ticas sin esperar:

```bash
# **Instalar herramienta de actualizaciones automÃ¡ticas**
sudo apt install unattended-upgrades  # <1>

# **Habilitar servicio**
sudo systemctl enable unattended-upgrades  # <2>
sudo systemctl start unattended-upgrades  # <2>
```

1. **unattended-upgrades** es el paquete que permite actualizaciones automÃ¡ticas sin intervenciÃ³n

2. **systemctl enable/start** configura el servicio para ejecutarse automÃ¡ticamente en el boot
sudo systemctl start unattended-upgrades

# **Verificar estado**
sudo systemctl status unattended-upgrades
```

### 2.2 Configurar QuÃ© Se Actualiza AutomÃ¡ticamente

**Editar configuraciÃ³n**:
```bash
# **Archivo de configuraciÃ³n**
sudo nano /etc/apt/apt.conf.d/50unattended-upgrades
```

Cambios importantes:
```bash
# **Habilitar solo actualizaciones de seguridad (recomendado)**
Unattended-Upgrade::Package-Blacklist {
};

# **Solo paquetes de seguridad (lÃ­nea clave)**
Unattended-Upgrade::Origins-Pattern {
    "origin=*,archive=*-security";
};

# **Permitir reinicio automÃ¡tico si es necesario**
Unattended-Upgrade::Automatic-Reboot "true";

# **Horario para reinicio (ej: 3 AM)**
Unattended-Upgrade::Automatic-Reboot-Time "03:00";
```

### 2.3 Notificar cambios por Email

```bash
# **Instalar herramienta de email**
sudo apt install mailutils

# **En /etc/apt/apt.conf.d/50unattended-upgrades, agregar**:
Unattended-Upgrade::Mail "diego@abacom.com";
Unattended-Upgrade::MailReport "only-on-change";
```

---

## 3. Firewall con UFW

### 3.1 Entender Firewall

Un firewall es una barrera entre tu servidor y la red. Controla quÃ© conexiones se permiten:

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Internet   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  FIREWALL    â”‚ â† UFW (controla quÃ© entra/sale)
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Servidor   â”‚
                   â”‚  (Servicios) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Reglas de firewall**:

- **ALLOW**: Permitir conexiÃ³n
- **DENY**: Bloquear conexiÃ³n
- **REJECT**: Rechazar (y notificar al cliente)
- **DROP**: Descartar silenciosamente

### 3.2 Instalar y Habilitar UFW

```bash
# **UFW (Uncomplicated Firewall) viene con Ubuntu**
# **Verificar si estÃ¡ instalado**
sudo apt install ufw

# **Habilitar firewall**
sudo ufw enable

# **Salida**:
# Firewall is active and enabled on system startup.

# **Ver estado**
sudo ufw status

# **Salida cuando estÃ¡ deshabilitado**:
# Status: inactive

# **Salida cuando estÃ¡ habilitado**:
# Status: active
# 
# To                         Action      From
# --                         ------      ----
# 22/tcp                     ALLOW       Anywhere
# 80/tcp                     ALLOW       Anywhere
# 443/tcp                    ALLOW       Anywhere
```

### 3.3 Reglas BÃ¡sicas

**Permitir puerto SSH** (Â¡CRÃTICO! Sino quedarÃ¡s bloqueado):

```bash
# **Permitir SSH (puerto 22)**
sudo ufw allow 22/tcp
# Ã³
sudo ufw allow ssh

# **Verificar**
sudo ufw status

# To                         Action      From
# --                         ------      ----
# 22/tcp                     ALLOW       Anywhere
```

**Permitir puertos web**:

```bash
# **Permitir HTTP (puerto 80)**
sudo ufw allow 80/tcp
sudo ufw allow http

# **Permitir HTTPS (puerto 443)**
sudo ufw allow 443/tcp
sudo ufw allow https

# **Permitir HTTP y HTTPS juntos**
sudo ufw allow "Nginx Full"
```

**Permitir puertos personalizados**:

```bash
# **Permitir puerto 8080 (TCP)**
sudo ufw allow 8080/tcp

# **Permitir puerto 5432 (PostgreSQL) solo desde IP especÃ­fica**
sudo ufw allow from 192.168.1.50 to any port 5432

# **Permitir rango de puertos**
sudo ufw allow 6000:6010/tcp

# **Permitir desde red especÃ­fica**
sudo ufw allow from 192.168.1.0/24 to any port 3306
```

**Denegar puertos**:

```bash
# **Bloquear conexiones SMTP (puerto 25) para prevenir spam**
sudo ufw deny 25/tcp

# **Bloquear puerto desde IP especÃ­fica**
sudo ufw deny from 203.0.113.1 to any port 22

# **Bloquear todo excepto SSH, HTTP, HTTPS**
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### 3.4 Eliminar Reglas

```bash
# **Listar reglas numeradas**
sudo ufw status numbered

# Num  To                         Action      From
# ---  --                         ------      ----
# 1    22/tcp                     ALLOW IN    Anywhere
# 2    80/tcp                     ALLOW IN    Anywhere
# 3    443/tcp                    ALLOW IN    Anywhere

# **Eliminar regla por nÃºmero**
sudo ufw delete 2
# Deleting:
#  allow 80/tcp
# Proceed with operation (y|n)? y

# **Eliminar regla por descripciÃ³n**
sudo ufw delete allow http
```

### 3.5 Reglas Avanzadas

```bash
# **Permitir con lÃ­mite de conexiones (prevenir brute force)**
sudo ufw limit 22/tcp
# Permite mÃ¡ximo 6 conexiones por 30 segundos

# **Ver reglas en formato verbose**
sudo ufw show added

# Added user rules (see 'ufw status' for running firewall):
# ufw allow 22/tcp
# ufw allow 80/tcp
# ufw allow 443/tcp

# **Resetear UFW a estado por defecto**
sudo ufw reset
```

### 3.6 ConfiguraciÃ³n de Inicio/Parada

```bash
# **Verificar si UFW estÃ¡ habilitado para startup**
sudo ufw status
# Status: active

# **Deshabilitar UFW temporalmente (se reactiva en reboot)**
sudo ufw disable

# **Habilitar de nuevo**
sudo ufw enable

# **Cargar reglas nuevas sin reiniciar**
sudo ufw reload
```

---

## 4. Hardening BÃ¡sico

### 4.1 Actualizar Bootloader

```bash
# **Proteger GRUB con contraseÃ±a (previene acceso fÃ­sico)**
sudo nano /etc/default/grub

# **Agregar lÃ­nea**:
# GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
# **Cambiar a**:
# GRUB_CMDLINE_LINUX_DEFAULT="quiet splash systemd.unit=multi-user.target"

# **Actualizar GRUB**
sudo update-grub
```

### 4.2 Deshabilitar Servicios Innecesarios

```bash
# **Ver servicios en ejecuciÃ³n**
sudo systemctl list-units --type=service --state=running

# **Deshabilitar servicio innecesario (ej: Bluetooth)**
sudo systemctl disable bluetooth
sudo systemctl stop bluetooth

# **Servicios que generalmente NO se necesitan en servidor**:
# - bluetooth
# - cups (impresoras)
# - avahi-daemon (mDNS)
# - isc-dhcp-server (si no lo usas)
```

### 4.3 Limitar Acceso a Archivos Sensibles

```bash
# **Proteger archivos de configuraciÃ³n sensibles**
sudo chmod 600 /etc/ssh/sshd_config

# **Asegurar log de auditorÃ­a**
sudo chmod 640 /var/log/auth.log

# **Proteger crontab de usuario**
sudo chmod 640 /etc/crontab

# **Archivos con permisos adecuados**
# /etc/passwd:     644 (legible por todos)
# /etc/shadow:     640 (solo root)
# /etc/sudoers:    440 (solo root, con visudo)
# /root/.ssh:      700 (solo root)
# ~/.ssh:          700 (solo usuario)
# ~/.ssh/id_rsa:   600 (solo usuario)
```

### 4.4 Audit y SELinux/AppArmor

**En Ubuntu, AppArmor es estÃ¡ndar** (SELinux es en CentOS):

```bash
# **Ver estado de AppArmor**
sudo systemctl status apparmor

# **Ver perfiles cargados**
sudo aa-status

# **Habilitar AppArmor**
sudo systemctl enable apparmor

# **NOTA**: AppArmor es mÃ¡s simple que SELinux
# Usa perfiles predefinidos para servicios comunes
```

### 4.5 Fail2Ban - Proteger contra Brute Force

```bash
# **Instalar Fail2Ban (bloquea IPs despuÃ©s de N intentos fallidos)**
sudo apt install fail2ban  # <1>

# **Habilitar**
sudo systemctl enable fail2ban  # <2>
sudo systemctl start fail2ban  # <2>

# **Ver estado**
sudo systemctl status fail2ban  # <3>

# **Ver intentos fallidos en SSH**
sudo fail2ban-client status sshd  # <4>

# **Salida**:
# Status for the jail sshd:
# |- Filter set to: sshd
# |- Currently failed: 0
# |- Currently banned: 2
# `- Total banned: 5
```

1. **fail2ban** es el sistema que detecta intentos fallidos de login y bloquea IPs automÃ¡ticamente

2. **systemctl enable/start** configura el servicio y lo inicia (enable = arrancar al boot, start = arrancar ahora)

3. **systemctl status** muestra si el servicio estÃ¡ activo (running) o detenido (inactive)

4. **fail2ban-client status sshd** muestra estadÃ­sticas: IPs actualmente baneadas y total histÃ³rico

---

## 5. Laboratorio PrÃ¡ctico: Actualizar y Asegurar Servidor

### 5.1 Escenario

Tienes un servidor Ubuntu reciÃ©n instalado que necesita:

1. Actualizar todos los paquetes

2. Configurar firewall bÃ¡sico

3. Habilitar actualizaciones automÃ¡ticas

4. Aplicar hardening inicial

### 5.2 Pasos

**PASO 1: Actualizar repositorios y paquetes**

```bash
# **Conectar al servidor**
ssh diego@192.168.1.100

# **Actualizar lista de paquetes**
sudo apt update

# **Upgrade seguro**
sudo apt upgrade

# **Responder 'S' cuando pregunte**
# Â¿Deseas continuar? [S/n] S

# **Limpiar paquetes no usados**
sudo apt autoremove
```

**PASO 2: Instalar Fail2Ban y UFW**

```bash
# **Instalar fail2ban**
sudo apt install fail2ban

# **Instalar UFW (probablemente ya viene)**
sudo apt install ufw

# **Habilitar UFW**
sudo ufw enable

# **Responder 'y' si pregunta si quieres continuar**
```

**PASO 3: Configurar firewall**

```bash
# **Permitir SSH (Â¡PRIMERO ESTO!)**
sudo ufw allow 22/tcp

# **Permitir HTTP**
sudo ufw allow 80/tcp

# **Permitir HTTPS**
sudo ufw allow 443/tcp

# **Verificar reglas**
sudo ufw status

# **Salida esperada**:
# Status: active
# 
# To                         Action      From
# --                         ------      ----
# 22/tcp                     ALLOW       Anywhere
# 80/tcp                     ALLOW       Anywhere
# 443/tcp                    ALLOW       Anywhere
```

**PASO 4: Configurar actualizaciones automÃ¡ticas**

```bash
# **Instalar unattended-upgrades**
sudo apt install unattended-upgrades

# **Habilitar**
sudo systemctl enable unattended-upgrades
sudo systemctl start unattended-upgrades

# **Verificar estado**
sudo systemctl status unattended-upgrades
```

**PASO 5: Verificar seguridad**

```bash
# **Ver estado de firewall**
sudo ufw status verbose

# **Ver servicios en escucha**
sudo ss -tulpn

# **Ver logs de fail2ban**
sudo fail2ban-client status

# **Ver logs de auditorÃ­a SSH**
sudo tail -20 /var/log/auth.log
```

---

## 6. Monitoreo de Seguridad

### 6.1 Ver Logs de Actualizaciones

```bash
# **Ver quÃ© se actualizÃ³**
cat /var/log/apt/history.log

# **Ver logs de unattended-upgrades**
sudo cat /var/log/unattended-upgrades/unattended-upgrades.log
```

### 6.2 AuditorÃ­a de Cambios Recientes

```bash
# **Ver cambios en archivo crÃ­tico**
sudo apt install aide

# **Inicializar base de datos AIDE**
sudo aideinit

# **Luego, verificar cambios**
sudo aide --check
```

---

## 7. Ejercicios PrÃ¡cticos

### Ejercicio 1: Crear polÃ­tica de actualizaciÃ³n

Define:

- CuÃ¡ndo actualizar (horarios)
- QuÃ© actualizar (seguridad, todas)
- CÃ³mo notificar (email)
- CuÃ¡ndo reiniciar (horario seguro)

**SoluciÃ³n**: Editar **/etc/apt/apt.conf.d/50unattended-upgrades** con:
```bash
Unattended-Upgrade::Origins-Pattern {
    "origin=*,archive=*-security";
};
Unattended-Upgrade::Automatic-Reboot "true";
Unattended-Upgrade::Automatic-Reboot-Time "03:00";
Unattended-Upgrade::Mail "admin@abacom.com";
```

### Ejercicio 2: Configurar firewall completo

Crea firewall para:

- SSH: Permitir solo desde IP 192.168.1.50
- HTTP/HTTPS: Permitir desde cualquiera
- MySQL: Permitir solo desde red 192.168.1.0/24
- Bloquear todo lo demÃ¡s

**SoluciÃ³n**:
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow from 192.168.1.50 to any port 22
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow from 192.168.1.0/24 to any port 3306
```

### Ejercicio 3: Crear script de backup antes de actualizar

Crea script que:

1. Hace backup de configuraciÃ³n

2. Ejecuta **apt update && apt upgrade**

3. Notifica resultado por log

4. Se ejecuta cada domingo a las 2 AM

**SoluciÃ³n**: Ver Anexo A (Bash Scripting) para crear script + crontab

---

## 8. Quiz de VerificaciÃ³n

1. **Â¿CuÃ¡l es la diferencia entre **apt upgrade** y **apt full-upgrade**?**

   - A) No hay diferencia
   - B) upgrade es mÃ¡s rÃ¡pido
   - C) full-upgrade puede remover paquetes; upgrade no
   - D) Respuesta C es correcta âœ…

2. **Â¿QuÃ© hace **sudo ufw allow 22/tcp** antes de **sudo ufw enable**?**

   - A) Permite acceso SSH para que no te bloquees
   - B) Es necesario antes de habilitar firewall
   - C) Protege SSH de ataques
   - D) Respuestas A y B son correctas âœ…

3. **Â¿CuÃ¡l es el comando para ver reglas de UFW numeradas?**

   - A) sudo ufw list
   - B) sudo ufw show
   - C) sudo ufw status numbered âœ…
   - D) sudo ufw rules

4. **Â¿QuÃ© es unattended-upgrades?**

   - A) ActualizaciÃ³n manual del sistema
   - B) Herramienta para actualizar automÃ¡ticamente âœ…
   - C) Comando para actualizar paquetes especÃ­ficos
   - D) Script para limpiar paquetes

5. **Â¿CuÃ¡l es la regla de seguridad al usar UFW?**

   - A) Permitir SSH al Ãºltimo
   - B) Permitir SSH al primero âœ…
   - C) No importa el orden
   - D) SSH no necesita regla

---

## 9. Resumen y Siguiente Paso

### Lo Aprendido

âœ… Actualizar paquetes de forma segura (**apt update**, **upgrade**)
âœ… Configurar actualizaciones automÃ¡ticas
âœ… Instalar y usar firewall UFW
âœ… Crear reglas de firewall apropiadas
âœ… Aplicar hardening inicial
âœ… Monitorear cambios de seguridad

### Siguiente: Unidad 2.5

El prÃ³ximo (y Ãºltimo) tema de Unidad 2 cubre:

- Comandos bÃ¡sicos de terminal
- NavegaciÃ³n del sistema de archivos
- Primeros pasos prÃ¡cticos

---

## ğŸ“š Referencias

[@ubuntu_updates_security]
[@ufw_firewall_guide]
[@fail2ban_protection]
[@unattended_upgrades_config]
[@ubuntu_hardening_guide]

---

## ğŸ“ Quiz: ActualizaciÃ³n y Seguridad

```{quizdown}
---
shuffleAnswers: true
---

## Â¿CuÃ¡l es el comando para actualizar la lista de paquetes en Ubuntu?

- [ ] apt upgrade
- [x] apt update
- [ ] apt refresh
- [ ] apt list

## Â¿CuÃ¡l es la diferencia entre `apt upgrade` y `apt full-upgrade`?

- [x] upgrade instala actualizaciones, full-upgrade tambiÃ©n elimina paquetes obsoletos
- [ ] upgrade es mÃ¡s rÃ¡pido
- [ ] full-upgrade es solo para servidores
- [ ] No hay diferencia

## Â¿QuÃ© paquete permite actualizaciones automÃ¡ticas en Ubuntu?

- [ ] auto-update
- [x] unattended-upgrades
- [ ] auto-patch
- [ ] background-updates

## Â¿CuÃ¡l es el archivo de configuraciÃ³n de unattended-upgrades?

- [ ] /etc/unattended-upgrades
- [x] /etc/apt/apt.conf.d/50unattended-upgrades
- [ ] /etc/unattended.conf
- [ ] /var/apt/unattended-upgrades

## Â¿QuÃ© es UFW?

- [ ] Un protocolo de red
- [x] Uncomplicated Firewall - interfaz simplificada para iptables
- [ ] Universal File Writer
- [ ] User Firewall

## Â¿CuÃ¡l comando habilita el firewall UFW?

- [ ] ufw on
- [x] ufw enable
- [ ] ufw activate
- [ ] ufw start

## Â¿CuÃ¡l comando permite conexiones SSH a travÃ©s del firewall?

- [ ] ufw allow port 22
- [x] ufw allow ssh
- [ ] ufw ssh allow
- [ ] ufw permit 22

## Â¿QuÃ© es Fail2Ban?

- [x] Sistema que detecta y bloquea intentos de acceso fallidos repetidos
- [ ] Herramienta para eliminar archivos
- [ ] Servicio de backup
- [ ] Monitor de memoria

## Â¿CuÃ¡l es el archivo de configuraciÃ³n principal de Fail2Ban?

- [ ] /etc/fail2ban.conf
- [x] /etc/fail2ban/jail.conf
- [ ] /etc/fail2ban/config
- [ ] /var/fail2ban/conf

## Â¿CuÃ¡ntos intentos fallidos tÃ­picamente bloquean a un usuario en Fail2Ban por defecto?

- [ ] 3
- [x] 5
- [ ] 10
- [ ] 15

## Â¿QuÃ© comando muestra las actualizaciones disponibles sin instalarlas?

- [x] apt list --upgradable
- [ ] apt check
- [ ] apt show-updates
- [ ] apt available

## Â¿CuÃ¡l es una buena prÃ¡ctica de seguridad al actualizar un servidor en producciÃ³n?

- [ ] Actualizar sin hacer respaldo
- [ ] Actualizar en horario de mÃ¡ximo uso
- [x] Hacer backup, actualizar en ventana de mantenimiento, verificar servicios
- [ ] Actualizar y reiniciar inmediatamente

## Â¿QuÃ© hace el comando `sudo apt autoremove`?

- [ ] Elimina todo tipo de archivos
- [x] Elimina paquetes que no son necesarios (dependencias de paquetes removidos)
- [ ] Elimina archivos automÃ¡ticamente
- [ ] Elimina directorios vacÃ­os

## Â¿CuÃ¡l es el puerto estÃ¡ndar para SSH?

- [ ] 2222
- [x] 22
- [ ] 2022
- [ ] 8022

## Â¿QuÃ© herramienta de lÃ­nea de comandos se usa frecuentemente para auditar puertos abiertos?

- [ ] port-scan
- [ ] netstat (antiguo)
- [x] ss (socket statistics)
- [ ] ports -list
```

---

